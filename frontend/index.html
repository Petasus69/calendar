<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Link Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; padding: 0; }
      header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid #eee; }
      main { padding: 16px; max-width: 1000px; margin: 0 auto; }
      .row { display: flex; gap: 8px; }
      #calendar { margin-top: 16px; }
      button { padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer; }
      button.primary { background: #2563eb; color: #fff; border-color: #2563eb; }
      dialog { border: none; border-radius: 8px; padding: 0; }
      .modal { padding: 16px; min-width: 300px; }
      .field { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }
      input, textarea { padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
    </style>
  </head>
  <body>
    <header>
      <div><strong>Link Calendar</strong></div>
      <div class="row">
        <button id="createBtn" class="primary">Создать календарь</button>
        <input id="uuidInput" placeholder="UUID календаря" />
        <button id="openBtn">Открыть</button>
      </div>
    </header>
    <main>
      <div id="share" style="display:none"></div>
      <div id="calendar"></div>
    </main>

    <dialog id="eventDialog">
      <form id="eventForm" class="modal">
        <h3>Новое событие</h3>
        <div class="field">
          <label>Заголовок</label>
          <input name="title" required />
        </div>
        <div class="field">
          <label>Описание</label>
          <textarea name="description"></textarea>
        </div>
        <div class="field">
          <label>Начало (дата обязательна, время — опционально)</label>
          <div class="row">
            <input name="startDate" type="date" required />
            <input name="startTime" type="time" />
          </div>
        </div>
        <div class="field">
          <label>Конец (дата обязательна, время — опционально)</label>
          <div class="row">
            <input name="endDate" type="date" required />
            <input name="endTime" type="time" />
          </div>
        </div>
        <div class="row" style="justify-content: flex-end;">
          <button type="button" id="cancelDialog">Отмена</button>
          <button type="submit" class="primary">Сохранить</button>
        </div>
      </form>
    </dialog>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script>
      // Минимальный клиент для API: без сборки, одна страница, FullCalendar.
      // Важные моменты:
      // - Работаем в локальной таймзоне (timeZone: 'local').
      // - AllDay события отображаем полосой, в API сохраняем как 00:00:00..23:59:59.
      // - /api/* проксируется nginx → backend:8000.
      const API_BASE = '/api';
      const calendarEl = document.getElementById('calendar');
      const shareEl = document.getElementById('share');
      const createBtn = document.getElementById('createBtn');
      const uuidInput = document.getElementById('uuidInput');
      const openBtn = document.getElementById('openBtn');
      const dlg = document.getElementById('eventDialog');
      const form = document.getElementById('eventForm');
      const cancelDialog = document.getElementById('cancelDialog');

      let currentUUID = null;
      let fc = null;

      function buildISO(dateStr, timeStr, isEnd) {
        const time = timeStr && timeStr.length ? timeStr : (isEnd ? '23:59:59' : '00:00:00');
        // Возвращаем локальное время без суффикса Z (без конвертации в UTC)
        return `${dateStr}T${time}`;
      }

      function toLocalIsoNoZ(dateObj) {
        const pad = (n) => String(n).padStart(2, '0');
        const Y = dateObj.getFullYear();
        const M = pad(dateObj.getMonth() + 1);
        const D = pad(dateObj.getDate());
        const h = pad(dateObj.getHours());
        const m = pad(dateObj.getMinutes());
        const s = pad(dateObj.getSeconds());
        return `${Y}-${M}-${D}T${h}:${m}:${s}`;
      }

      async function createCalendar() {
        const res = await fetch(`${API_BASE}/calendars`, { method: 'POST' });
        if (!res.ok) { alert('Ошибка создания'); return; }
        const data = await res.json();
        currentUUID = data.uuid;
        uuidInput.value = currentUUID;
        shareEl.style.display = 'block';
        shareEl.textContent = `Ссылка для общего доступа: ${data.share_url}`;
        initCalendar();
      }

      async function loadEvents(fetchInfo, successCallback, failureCallback) {
        if (!currentUUID) return successCallback([]);
        try {
          const res = await fetch(`${API_BASE}/calendars/${currentUUID}/events`);
          const events = await res.json();
          const mapped = events.map(e => {
            // Если событие ровно один день без времени (00:00:00..23:59:59), отображаем как allDay-полоску
            const isBoundary = (s, e2) => {
              if (!s || !e2) return false;
              const ms = s.match(/^([0-9]{4}-[0-9]{2}-[0-9]{2})T00:00:00$/);
              const me = e2.match(/^([0-9]{4}-[0-9]{2}-[0-9]{2})T23:59:59$/);
              if (!ms || !me) return false;
              return ms[1] === me[1];
            };
            if (isBoundary(e.start, e.end)) {
              const day = e.start.substring(0, 10);
              const d = new Date(day + 'T00:00:00');
              d.setDate(d.getDate() + 1); // exclusive end
              const pad = n => String(n).padStart(2, '0');
              const dayNext = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
              return { id: e.id, title: e.title, start: day, end: dayNext, allDay: true };
            }
            return { id: e.id, title: e.title, start: e.start, end: e.end, display: 'block' };
          });
          successCallback(mapped);
        } catch (e) {
          failureCallback(e);
        }
      }

      function initCalendar() {
        if (fc) { fc.destroy(); }
        fc = new FullCalendar.Calendar(calendarEl, {
          timeZone: 'local',
          initialView: 'dayGridMonth',
          height: 'auto',
          headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
          events: loadEvents,
          selectable: true,
          select: (info) => {
            // prefill dialog date fields
            const start = new Date(info.start);
            const end = new Date(info.end);
            const pad = (n) => String(n).padStart(2, '0');
            const toDateInput = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
            form.startDate.value = toDateInput(start);
            form.startTime.value = '';
            // FullCalendar selection end is exclusive для all-day; уменьшим на день для отображения
            if (info.allDay) {
              end.setDate(end.getDate() - 1);
            }
            form.endDate.value = toDateInput(end);
            form.endTime.value = '';
            dlg.showModal();
          },
          editable: true,
          eventDrop: async (info) => {
            await fetch(`${API_BASE}/calendars/${currentUUID}/events/${info.event.id}`, {
              method: 'PUT', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify((() => {
                if (info.event.allDay) {
                  const start = new Date(info.event.start);
                  const endExcl = info.event.end ? new Date(info.event.end) : new Date(start.getTime() + 24*60*60*1000);
                  // преобразуем allDay [start, endExclusive) в [start 00:00:00, (endExclusive-1day) 23:59:59]
                  const pad = n => String(n).padStart(2,'0');
                  const toDate = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
                  const startStr = `${toDate(start)}T00:00:00`;
                  const endInc = new Date(endExcl);
                  endInc.setDate(endInc.getDate()-1);
                  const endStr = `${toDate(endInc)}T23:59:59`;
                  return { start: startStr, end: endStr };
                }
                return { start: toLocalIsoNoZ(info.event.start), end: info.event.end ? toLocalIsoNoZ(info.event.end) : toLocalIsoNoZ(info.event.start) };
              })())
            });
          },
          eventResize: async (info) => {
            await fetch(`${API_BASE}/calendars/${currentUUID}/events/${info.event.id}`, {
              method: 'PUT', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify((() => {
                if (info.event.allDay) {
                  // end в allDay exclusive -> сделаем inclusive 23:59:59 предыдущего дня
                  const endExcl = new Date(info.event.end);
                  const pad = n => String(n).padStart(2,'0');
                  const toDate = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
                  const endInc = new Date(endExcl);
                  endInc.setDate(endInc.getDate()-1);
                  const endStr = `${toDate(endInc)}T23:59:59`;
                  return { end: endStr };
                }
                return { end: toLocalIsoNoZ(info.event.end) };
              })())
            });
          },
          eventClick: async (info) => {
            if (!confirm('Удалить событие?')) return;
            await fetch(`${API_BASE}/calendars/${currentUUID}/events/${info.event.id}`, { method: 'DELETE' });
            fc.refetchEvents();
          }
        });
        fc.render();
      }

      createBtn.addEventListener('click', createCalendar);
      openBtn.addEventListener('click', () => {
        if (!uuidInput.value) return alert('Введите UUID');
        currentUUID = uuidInput.value.trim();
        shareEl.style.display = 'block';
        shareEl.textContent = `${location.origin}/c/${currentUUID}`;
        initCalendar();
      });
      cancelDialog.addEventListener('click', () => dlg.close());
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
          title: form.title.value.trim(),
          description: form.description.value.trim() || null,
          start: buildISO(form.startDate.value, form.startTime.value, false),
          end: buildISO(form.endDate.value, form.endTime.value, true),
        };
        const res = await fetch(`${API_BASE}/calendars/${currentUUID}/events`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        if (!res.ok) { alert('Ошибка сохранения'); return; }
        dlg.close();
        fc.refetchEvents();
      });

      // deep link /c/{uuid}
      const m = location.pathname.match(/\/c\/(.+)$/);
      if (m) {
        currentUUID = m[1];
        uuidInput.value = currentUUID;
        shareEl.style.display = 'block';
        shareEl.textContent = `${location.origin}/c/${currentUUID}`;
        initCalendar();
      }
    </script>
  </body>
  </html>


